name: DevSecOps CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:

env:
  IMAGE_TAG: ${{ github.sha }}

jobs:
  # ============================================================
  #  STAGE 1 – Instalación reproducible & Testing automático
  # ============================================================
  install-and-test:
    name: "1 · Install & Test"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # ---------- backend: users-service ----------
      - name: "Install users-service (npm ci)"
        working-directory: backend/users-service
        run: npm ci

      - name: "Test users-service"
        working-directory: backend/users-service
        run: npm test

      # ---------- backend: academic-service ----------
      - name: "Install academic-service (npm ci)"
        working-directory: backend/academic-service
        run: npm ci

      - name: "Test academic-service"
        working-directory: backend/academic-service
        run: npm test

      # ---------- backend: api-gateway ----------
      - name: "Install api-gateway (npm ci)"
        working-directory: backend/api-gateway
        run: npm ci

      - name: "Test api-gateway"
        working-directory: backend/api-gateway
        run: npm test

      # ---------- frontend ----------
      - name: "Install frontend (npm ci)"
        working-directory: frontend
        run: npm ci

      - name: "Test frontend"
        working-directory: frontend
        run: npm test

  # ============================================================
  #  STAGE 2 – Análisis de calidad de código (ESLint)
  # ============================================================
  code-quality:
    name: "2 · Code Quality (ESLint)"
    runs-on: ubuntu-latest
    needs: install-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: "Lint frontend (ESLint)"
        working-directory: frontend
        run: |
          npm ci
          npx eslint . --max-warnings 0

      - name: "Lint users-service"
        working-directory: backend/users-service
        run: |
          npm ci
          npx eslint src/ --max-warnings 0 || true

      - name: "Lint academic-service"
        working-directory: backend/academic-service
        run: |
          npm ci
          npx eslint src/ --max-warnings 0 || true

      - name: "Lint api-gateway"
        working-directory: backend/api-gateway
        run: |
          npm ci
          npx eslint src/ --max-warnings 0 || true

  # ============================================================
  #  STAGE 3 – SAST (Semgrep)
  # ============================================================
  sast:
    name: "3 · SAST (Semgrep)"
    runs-on: ubuntu-latest
    needs: install-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Semgrep
        run: pip install semgrep

      # Reglas automáticas + reglas custom del repositorio
      - name: "SAST – users-service"
        working-directory: backend/users-service
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=ERROR --error

      - name: "SAST – academic-service"
        working-directory: backend/academic-service
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=ERROR --error

      - name: "SAST – api-gateway"
        working-directory: backend/api-gateway
        run: semgrep --config=auto --config=../semgrep-rules/ --severity=ERROR --error

      - name: "SAST – frontend"
        working-directory: frontend
        run: semgrep --config=auto --severity=ERROR --error

  # ============================================================
  #  STAGE 4 – SCA – Seguridad de dependencias (npm audit)
  # ============================================================
  sca:
    name: "4 · SCA (npm audit)"
    runs-on: ubuntu-latest
    needs: install-and-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: "Audit users-service"
        working-directory: backend/users-service
        run: |
          npm ci
          npm audit --audit-level=critical

      - name: "Audit academic-service"
        working-directory: backend/academic-service
        run: |
          npm ci
          npm audit --audit-level=critical

      - name: "Audit api-gateway"
        working-directory: backend/api-gateway
        run: |
          npm ci
          npm audit --audit-level=critical

      - name: "Audit frontend"
        working-directory: frontend
        run: |
          npm ci
          npm audit --audit-level=critical

  # ============================================================
  #  STAGE 5 – Build de contenedores Docker
  # ============================================================
  docker-build:
    name: "5 · Docker Build"
    runs-on: ubuntu-latest
    needs: [code-quality, sast, sca]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create env files for Docker Compose
        run: |
          # Backend
          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          # Frontend
          cp frontend/.env.example frontend/.env

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: "Build all images (docker compose)"
        run: |
          docker compose -f backend/docker-compose.yml build
          echo "=== Images built ==="
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"

      # Guardar imágenes como artefactos para el siguiente job
      - name: Save Docker images
        run: |
          docker save users-service:latest   -o /tmp/users-service.tar
          docker save academic-service:latest -o /tmp/academic-service.tar
          docker save api-gateway:latest      -o /tmp/api-gateway.tar
          docker save frontend:latest         -o /tmp/frontend.tar

      - name: Upload image artifacts
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: /tmp/*.tar
          retention-days: 1

  # ============================================================
  #  STAGE 6 – Seguridad de contenedores (Trivy)
  # ============================================================
  container-security:
    name: "6 · Container Security (Trivy)"
    runs-on: ubuntu-latest
    needs: docker-build
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      - name: Load Docker images
        run: |
          docker load -i /tmp/users-service.tar
          docker load -i /tmp/academic-service.tar
          docker load -i /tmp/api-gateway.tar
          docker load -i /tmp/frontend.tar

      - name: "Trivy – users-service"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "users-service:latest"
          format: table
          severity: CRITICAL
          exit-code: "1"

      - name: "Trivy – academic-service"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "academic-service:latest"
          format: table
          severity: CRITICAL
          exit-code: "1"

      - name: "Trivy – api-gateway"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "api-gateway:latest"
          format: table
          severity: CRITICAL
          exit-code: "1"

      - name: "Trivy – frontend"
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: "frontend:latest"
          format: table
          severity: CRITICAL
          exit-code: "1"

  # ============================================================
  #  STAGE 7 – Smoke Test (docker-compose up)
  # ============================================================
  smoke-test:
    name: "7 · Smoke Test"
    runs-on: ubuntu-latest
    needs: container-security
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download image artifacts
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: /tmp

      - name: Load Docker images
        run: |
          docker load -i /tmp/users-service.tar
          docker load -i /tmp/academic-service.tar
          docker load -i /tmp/api-gateway.tar
          docker load -i /tmp/frontend.tar

      - name: Create env files
        run: |
          cp backend/users-service/.env.example backend/users-service/.env
          cp backend/academic-service/.env.example backend/academic-service/.env
          cp backend/api-gateway/.env.example backend/api-gateway/.env
          cp frontend/.env.example frontend/.env

      - name: "Start services"
        run: |
          docker compose -f backend/docker-compose.yml up -d
          sleep 20

      - name: "Health check – API Gateway"
        run: curl --fail --retry 5 --retry-delay 3 http://localhost:3000/health

      - name: "Shutdown services"
        if: always()
        run: docker compose -f backend/docker-compose.yml down || true